{"metadata": {"dbt_schema_version": "https://schemas.getdbt.com/dbt/run-results/v6.json", "dbt_version": "1.9.3", "generated_at": "2025-03-31T20:30:05.365084Z", "invocation_id": "a3b72256-bf79-4c76-9549-a9b2f386bff0", "env": {}}, "results": [{"status": "success", "timing": [{"name": "compile", "started_at": "2025-03-31T20:30:00.338288Z", "completed_at": "2025-03-31T20:30:00.347894Z"}, {"name": "execute", "started_at": "2025-03-31T20:30:00.348865Z", "completed_at": "2025-03-31T20:30:03.691824Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 3.3555357456207275, "adapter_response": {"_message": "SELECT 49", "code": "SELECT", "rows_affected": 49}, "message": "SELECT 49", "failures": null, "unique_id": "model.meu_projeto_dbt.raw_cliente_pedido_pendente", "compiled": true, "compiled_code": "-- Quantidade de pedidos 'Pendentes' por cliente ->> ultimos 7 dias\n-- Sugest\u00e3o aplicar um desconto de acordo com o valor total do pedido, conforme a regra abaixo:\n-- Se o valor total do pedido for maior que R$ 1.000,00, aplicar um desconto de 15%\n-- Se o valor total do pedido for maior que R$ 500,00, aplicar um desconto de 10%\n-- Se o valor total do pedido for menor ou igual a R$ 500,00, n\u00e3o aplicar desconto\n\n-- Enviar email para o cliente com os pedidos pendentes ->> ultimos 7 dias\n-- Sugest\u00e3o enviar email com os dados do pedido, incluindo o valor total com desconto e o percentual de desconto aplicado\n\nWITH cliente_pedido_pendente AS (\n    SELECT \n        c.id_cliente,\n        FIRST_VALUE(c.primeiro_nome) OVER (PARTITION BY c.id_cliente) AS primeiro_nome,  \n        c.email,\n        p.id_pedido,\n        p.data_pedido,\n        p.total,\n        cv.descricao_canal_venda,\n        COUNT(it.id_produto) AS qtd_itens_pedido,\n        STRING_AGG(pr.descricao_produto, ',') AS produtos,\n        \n        -- Aplica o desconto\n        CASE \n            WHEN p.total > 1000 THEN p.total * 0.85  -- Desconto de 15%\n            WHEN p.total > 500 THEN p.total * 0.9   -- Desconto de 10%\n            ELSE p.total  \n        END AS total_com_desconto,\n\n        -- Indica qual desconto foi aplicado\n        CASE \n            WHEN p.total > 1000 THEN 15\n            WHEN p.total > 500 THEN 10\n            ELSE 0  \n        END AS percentual_desconto,\n        \n        -- Contagem de pedidos pendentes por cliente\n        COUNT(*) OVER (PARTITION BY c.id_cliente) AS qtd_pedidos_pendentes,\n\n        -- Soma total de descontos aplicados por cliente\n        SUM(\n            CASE \n                WHEN p.total > 1000 THEN p.total * 0.15  \n                WHEN p.total > 500 THEN p.total * 0.10\n                ELSE 0  \n            END\n        ) OVER (PARTITION BY c.id_cliente) AS valor_desconto\n        \n    FROM \"dbtvendas_82ea\".\"public_staging\".\"stg_cliente\" c\n    INNER JOIN \"dbtvendas_82ea\".\"public_raw\".\"raw_pedido\" p \n        ON c.id_cliente = p.id_cliente\n    INNER JOIN \"dbtvendas_82ea\".\"public_staging\".\"stg_canais_venda\" cv\n        ON p.id_canal_venda = cv.id_canal_venda\n    INNER JOIN \"dbtvendas_82ea\".\"public_staging\".\"stg_itens_pedido\" it\n        ON p.id_pedido = it.id_pedido\n    INNER JOIN \"dbtvendas_82ea\".\"public_staging\".\"stg_produto\" pr\n        ON it.id_produto = pr.id_produto\n    WHERE p.id_status = 1  \n    AND p.data_pedido >= CURRENT_DATE - INTERVAL '7 days'  \n    GROUP BY \n        c.id_cliente, c.primeiro_nome, c.email, \n        p.id_pedido, p.data_pedido, p.total, \n        cv.descricao_canal_venda \n)\nSELECT \n    id_cliente, \n    primeiro_nome,\n    email,\n    data_pedido,\n    id_pedido,\n    qtd_itens_pedido,\n    produtos,\n    'R$' || TO_CHAR(total, 'FM999G999G999D99') AS total, \n    percentual_desconto || '%' AS desconto, \n    'R$' || TO_CHAR(valor_desconto, 'FM999G999G999D99') AS valor_desconto,\n    'R$' || TO_CHAR(total_com_desconto, 'FM999G999G999D99') AS total_com_desconto,\n    'R$' || TO_CHAR(SUM(total_com_desconto) OVER (ORDER BY id_cliente), 'FM999G999G999D99') AS soma_acumulada,\n    descricao_canal_venda,\n    qtd_pedidos_pendentes\nFROM cliente_pedido_pendente\nORDER BY id_cliente, id_pedido", "relation_name": "\"dbtvendas_82ea\".\"public_raw\".\"raw_cliente_pedido_pendente\"", "batch_results": null}], "elapsed_time": 13.52966570854187, "args": {"select": ["raw_cliente_pedido_pendente"], "version_check": true, "require_nested_cumulative_type_params": false, "log_format_file": "debug", "invocation_command": "dbt run --select raw_cliente_pedido_pendente", "log_level_file": "debug", "partial_parse_file_diff": true, "introspect": true, "skip_nodes_if_on_run_start_fails": false, "project_dir": "D:\\Prjts\\AED_DBT\\dbt_project", "use_colors_file": true, "static_parser": true, "quiet": false, "which": "run", "print": true, "require_yaml_configuration_for_mf_time_spines": false, "printer_width": 80, "state_modified_compare_vars": false, "strict_mode": false, "defer": false, "empty": false, "require_explicit_package_overrides_for_builtin_materializations": true, "send_anonymous_usage_stats": true, "log_path": "D:\\Prjts\\AED_DBT\\dbt_project\\logs", "log_file_max_bytes": 10485760, "require_batched_execution_for_custom_microbatch_strategy": false, "cache_selected_only": false, "favor_state": false, "indirect_selection": "eager", "show_resource_report": false, "write_json": true, "macro_debugging": false, "log_format": "default", "vars": {}, "warn_error_options": {"include": [], "exclude": []}, "exclude": [], "partial_parse": true, "profiles_dir": "C:\\Users\\Lucas\\.dbt", "require_resource_names_without_spaces": false, "populate_cache": true, "state_modified_compare_more_unrendered_values": false, "log_level": "info", "source_freshness_run_project_hooks": false, "use_colors": true}}
