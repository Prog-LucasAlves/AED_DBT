CREATE TABLE DBTVENDAS_82EA.PUBLIC_RAW.RAW_VALOR_TOTAL_FORMA_PAGAMENTO__DBT_TMP


AS

(
    WITH TOTAL_POR_FORMA_PAGAMENTO AS (
        SELECT
            FP.DESCRICAO_METODO_PAGAMENTO,
            sum(P.TOTAL) AS TOTAL
        FROM DBTVENDAS_82EA.PUBLIC_STAGING.STG_PEDIDO P
        INNER JOIN DBTVENDAS_82EA.PUBLIC_STAGING.STG_FORMAS_PAGAMENTO FP
            ON P.ID_FORMA_PAGAMENTO = FP.ID_FORMA_PAGAMENTO
        GROUP BY FP.DESCRICAO_METODO_PAGAMENTO
    )

    SELECT
        DESCRICAO_METODO_PAGAMENTO,
        'R$' || to_char(TOTAL, 'FM999G999G999D99') AS TOTAL_FORMATADO,
        round((TOTAL * 100.0 / (
            SELECT sum(TOTAL)
            FROM TOTAL_POR_FORMA_PAGAMENTO
        ))::numeric, 2) AS PERCENTUAL
    FROM TOTAL_POR_FORMA_PAGAMENTO
    ORDER BY TOTAL DESC
);
