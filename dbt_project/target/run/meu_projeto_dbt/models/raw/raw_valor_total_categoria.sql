CREATE TABLE DBTVENDAS_82EA.PUBLIC_RAW.RAW_VALOR_TOTAL_CATEGORIA__DBT_TMP


AS

(
    WITH TOTAL_POR_CATEGORIA AS (
        SELECT
            CT.DESCRICAO_CATEGORIA,
            sum(P.TOTAL) AS TOTAL
        FROM DBTVENDAS_82EA.PUBLIC_STAGING.STG_PEDIDO P
        INNER JOIN DBTVENDAS_82EA.PUBLIC_STAGING.STG_CATEGORIA CT
            ON P.ID_CATEGORIA = CT.ID_CATEGORIA
        GROUP BY CT.DESCRICAO_CATEGORIA
    )

    SELECT
        DESCRICAO_CATEGORIA,
        'R$' || to_char(TOTAL, 'FM999G999G999D99') AS TOTAL_FORMATADO,
        round((TOTAL * 100.0 / (
            SELECT sum(TOTAL)
            FROM TOTAL_POR_CATEGORIA
        ))::numeric, 2) AS PERCENTUAL
    FROM TOTAL_POR_CATEGORIA
    ORDER BY TOTAL DESC
);
