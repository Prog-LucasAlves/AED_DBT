CREATE TABLE DBTVENDAS_82EA.PUBLIC_RAW.RAW_QTD_CLIENTES__DBT_TMP


AS

(
    WITH TOTAL_POR_CANAL_VENDA AS (
        SELECT
            CV.DESCRICAO_CANAL_VENDA,
            SUM(P.TOTAL) AS TOTAL  -- Mantém como número para cálculos
        FROM DBTVENDAS_82EA.PUBLIC_STAGING.STG_PEDIDO P
        INNER JOIN DBTVENDAS_82EA.PUBLIC_STAGING.STG_CANAIS_VENDA CV
            ON P.ID_CANAL_VENDA = CV.ID_CANAL_VENDA
        GROUP BY CV.DESCRICAO_CANAL_VENDA
    )

    SELECT
        DESCRICAO_CANAL_VENDA,
        -- Conversão para string só aqui
        'R$' || TO_CHAR(TOTAL, 'FM999G999G999D99') AS TOTAL_FORMATADO,
        ROUND(
            (
                TOTAL * 100.0 / (SELECT SUM(TOTAL) FROM TOTAL_POR_CANAL_VENDA)
            )::NUMERIC,
            2
        ) AS PERCENTUAL
    FROM TOTAL_POR_CANAL_VENDA
    ORDER BY TOTAL DESC
);
