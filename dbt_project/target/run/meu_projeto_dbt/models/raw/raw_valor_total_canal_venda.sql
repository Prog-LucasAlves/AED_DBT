CREATE TABLE DBTVENDAS_82EA.PUBLIC_RAW.RAW_VALOR_TOTAL_CANAL_VENDA__DBT_TMP


AS

(
    WITH TOTAL_POR_CANAL_VENDA AS (
        SELECT
            CV.DESCRICAO_CANAL_VENDA,
            sum(P.TOTAL) AS TOTAL
        FROM DBTVENDAS_82EA.PUBLIC_STAGING.STG_PEDIDO P
        INNER JOIN DBTVENDAS_82EA.PUBLIC_STAGING.STG_CANAIS_VENDA CV
            ON P.ID_CANAL_VENDA = CV.ID_CANAL_VENDA
        GROUP BY CV.DESCRICAO_CANAL_VENDA
    )

    SELECT
        DESCRICAO_CANAL_VENDA,
        'R$' || to_char(TOTAL, 'FM999G999G999D99') AS TOTAL_FORMATADO,
        round((TOTAL * 100.0 / (
            SELECT sum(TOTAL)
            FROM TOTAL_POR_CANAL_VENDA
        ))::numeric, 2) AS PERCENTUAL
    FROM TOTAL_POR_CANAL_VENDA
    ORDER BY TOTAL DESC
);
